Autore: Marco Russi
Data: 04/04/2016


BLE LED STRIP DIMMER


1 - BLE
1.1 - Advertisement

The advertising packet is formed as following:

0x02,								/* first length */
ADV_FLAGS_TYPE,						/* adv flags type */
BR_EDR_NOT_SUPPORTED,				/* BR/EDR not supported */
(uint8_t)(MANUF_DATA_LENGTH + 4),	/* second length */
MANUF_DATA_TYPE,					/* manufacturer data type */
(uint8_t)MANUFACTURER_ID,			/* manufacturer ID lower byte */
(uint8_t)(MANUFACTURER_ID >> 8),	/* manufacturer ID higher byte */
MANUF_DATA_LENGTH,					/* manufacturer specific data length */
(uint8_t)MANUF_PRODUCT_ID,			/* product type ID lower byte */
(uint8_t)(MANUF_PRODUCT_ID >> 8),	/* product type ID higher byte */
(uint8_t)MANUF_SERVICE_ID,			/* service UUID lower byte */
(uint8_t)(MANUF_SERVICE_ID >> 8),	/* service UUID higher byte */
(uint8_t)FIXED_DEVICE_ID,			/* Device ID byte 0 */
(uint8_t)(FIXED_DEVICE_ID >> 8),	/* Device ID byte 1 */
(uint8_t)(FIXED_DEVICE_ID >> 16),	/* Device ID byte 2 */
(uint8_t)(FIXED_DEVICE_ID >> 24),	/* Device ID byte 3 */
INITIAL_FACE_INDEX_VALUE,			/* Data 0 */
0x00,								/* Data 1 */
0x00,								/* Data 2 */
0x00,								/* Data 3 */
0x00,								/* Data 4 */
0x00,								/* Data 5 */
0x00,								/* Data 6 */
0x00,								/* Data 7 */
0x00,								/* reserved 0 */
0x00,								/* reserved 1 */
TX_POWER_MEASURED_RSSI				/* Calibrated TX RSSI */

A MANUFACTURER_ID is attributed at each company from Bluetooth SIG and in this case it is flashed at EOL.
The MANUF_PRODUCT_ID and FIXED_DEVICE_ID are defined at EOL and flashed into the flash memory of the device. 
The first one represents a unique code to identify a specific product type. The second one is unique for each device of the same product type or not.
For example, a specific model of lamp is produced in 1000 pieces. Each lamp has the same MANUF_PRODUCT_ID but unique FIXED_DEVICE_ID with a variation of 1000.
The TX_POWER_MEASURED_RSSI field is a a calibrated value of RSSI in two's complement (TO BE DEFINED). 
Each advertising packet has 8 bytes of data that depend on the product type. For this product the first byte only is used and it represents the selected face of the cube. So, it can vary from 1 to 6.


1.2 - Services

There is only one service available which contains the following characteristics:
- LIGHT
- PRESET
- DFU UPGRADE
The base UUID of the service is:
{{0x8A, 0xAF, 0xA6, 0xC2, 0x3A, 0x32, 0x8F, 0x84, 0x75, 0x4F, 0xF3, 0x02, 0x01, 0x50, 0x65, 0x20}} 
and the related UUID of the service is incremented by while the three characteristics have an increment of respectively 0x05, 0x0A and 0x0F. 

1.2.1 - LIGHT characteristic
This characteristic is 5 bytes long and represents the 4 PWM values and fade of the RGBW channels to apply on run time. Each PWM value is 1 byte long and can vary from 0 to 100 representing respectively 0% and 100% of duty cycle. The fade value can vary from 1 to 200 (1% to 200%) and it represents the amount of PWM percentage to apply at each fade step which fixed at 100 ms at the moment. The characteristic has read and write access and upon write operation the new values are immediately updated on the RGBW LED.

1.2.2 - PRESET characteristic
This characteristic is 30 bytes long and contains the 4 PWM values and fade of the RGBW channels for 6 pre-defined configurations. The meaning of each field is the same as dscribed for the LIGHT characteristic; it is basically an 6 elements array where each element is a LIGHT characteristic. The value has read and write access and new values are stored in the persistent memory of the chip.

1.2.3 - DFU UPGRADE characteristic
This characteristic is 1 byte long and when its value is set with a write operation to 0xA9 then the device enters in bootloader mode.











